name: Build Arch Package

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-arch:
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm git cmake zstd
        # Add user builder
        useradd -m builder
        echo "builder ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builder
        
    - name: Build Package
      run: |
        # Fix permissions for builder
        chown -R builder:builder .
        
        # Switch to builder and build
        # makepkg will clone the repo from the URL in PKGBUILD
        su builder -c "
          cd packages/arch
          makepkg -s --noconfirm
        "
        
    - name: Compress Binary
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      run: |
        # Compress the binary built by makepkg
        zstd packages/arch/src/unspoken/build/unspoken -o unspoken.zst

    - name: Find Package File
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      id: find_package
      run: |
        PKG_PATH=$(ls packages/arch/*.pkg.tar.zst)
        echo "pkg_path=$PKG_PATH" >> $GITHUB_OUTPUT
        echo "pkg_name=$(basename $PKG_PATH)" >> $GITHUB_OUTPUT

    - name: Create Draft Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: arch-${{ github.sha }}
        release_name: Arch Package ${{ github.sha }}
        draft: true
        prerelease: false

    - name: Upload Package Asset
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      uses: actions/upload-release-asset@v1.0.1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.find_package.outputs.pkg_path }}
        asset_name: unspoken-git.pkg.tar.zst
        asset_content_type: application/zstd

    - name: Upload Binary Asset
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      uses: actions/upload-release-asset@v1.0.1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: unspoken.zst
        asset_name: unspoken.zst
        asset_content_type: application/zstd

    - uses: eregon/publish-release@v1
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        release_id: ${{ steps.create_release.outputs.id }}